const palettes = {
    "Catppuccin": {
        "Latte": {
            "base": "#EFF1F5",
            "mantle": "#E6E9EF",
            "crust": "#DCE0E8",

            "text": "#4C4F69",

            "pink": "#EA76CB",
            "purple": "#8839EF",
            "red": "#D20F39",
            "light_red": "#E64553",
            "orange": "#FE640B",
            "yellow": "#DF8E1D",
            "green": "#40A02B",
            "light_green": "#179299",
            "blue": "#1E66F5",
            "light_blue": "#7287FD"
        },
        "Frappe": {
            "base": "#303446",
            "mantle": "#292C3C",
            "crust": "#232634",

            "text": "#C6D0F5",

            "pink": "#F4B8E4",
            "purple": "#CA9EE6",
            "red": "#E78284",
            "light_red": "#EA999C",
            "orange": "#EF9F76",
            "yellow": "#E5C890",
            "green": "#A6D189",
            "light_green": "#81C8BE",
            "blue": "#8CAAEE",
            "light_blue": "#85C1DC"
        },
        "Macchiato": {
            "base": "#24273A",
            "mantle": "#1E2030",
            "crust": "#181926",

            "text": "#CAD3F5",

            "pink": "#F5bDE6",
            "purple": "#C6A0F6",
            "red": "#ED8796",
            "light_red": "#EE99A0",
            "orange": "#F5A97F",
            "yellow": "#EED49F",
            "green": "#A6DA95",
            "light_green": "#8BD5CA",
            "blue": "#8AADF4",
            "light_blue": "#7DC4E4"
        },
        "Mocha": {
            "base": "#1E1E2E",
            "mantle": "#181825",
            "crust": "#11111b",

            "text": "#CDD6F4",

            "pink": "#F5C2E7",
            "purple": "#CBA6F7",
            "red": "#F38BA8",
            "light_red": "#EBA0AC",
            "orange": "#FAB387",
            "yellow": "#F9E2AF",
            "green": "#A6E3A1",
            "light_green": "#94E2D5",
            "blue": "#89B4FA",
            "light_blue": "#74C7EC"
        },
    },
    "Arc": {
        "Dark": {
            "base": "#282C34",
            "mantle": "#333842",
            "crust": "#2C313A",

            "text": "#ABB2BF",

            "pink": "#FF6AC1",
            "purple": "#D38AEA",
            "red": "#E06C75",
            "light_red": "#BE5046",
            "orange": "#DA8548",
            "yellow": "#E5D07b",
            "green": "#98C379",
            "light_green": "#87BF70",
            "blue": "#61AFEF",
            "light_blue": "#4DB5BD"
        },

        "Light": {
            "base": "#FAFAFA",
            "mantle": "#EFF0EB",
            "crust": "#F2F3F7",

            "text": "#545862",

            "pink": "#FF75A0",
            "purple": "#BF9EEE",
            "red": "#F47067",
            "light_red": "#F47067",
            "orange": "#FF9F50",
            "yellow": "#F7BB47",
            "green": "#6BC46D",
            "light_green": "#42B983",
            "blue": "#58A6FF",
            "light_blue": "#73D0FF"
        }
    },
    "Material": {
        "Oceanic": {
            "base": "#015970",
            "mantle": "#0a2540",
            "crust": "#0c3b62",

            "text": "#ECEFF4",
            "pink": "#FF3366",

            "purple": "#AD82EC",
            "red": "#FF5370",
            "light_red": "#F78C6C",
            "orange": "#FFCB6B",
            "yellow": "#FAB795",
            "green": "#C3E88D",
            "light_green": "#A3BE8C",
            "blue": "#82AAFF",
            "light_blue": "#80CBC4",
        },
        "Darker": {
            "base": "#1B262C",
            "mantle": "#0F4C75",
            "crust": "#3282B8",

            "text": "#F7F7FF",

            "pink": "#FEB236",
            "purple": "#6B5B95",
            "red": "#D81159",
            "light_red": "#DB504A",
            "orange": "#FFBC42",
            "yellow": "#F0F66E",
            "green": "#0EAD69",
            "light_green": "#07BEB8",
            "blue": "#0A9396",
            "light_blue": "#00B2CA",
        },
        "Lighter": {
            "base": "#EAEAEA",
            "mantle": "#DADADA",
            "crust": "#C4C4C4",

            "text": "#141414",

            "pink": "#FFB7C5",
            "purple": "#D7A9E3",
            "red": "#FF6363",
            "light_red": "#FF9A8B",
            "orange": "#FFD56D",
            "yellow": "#FAED26",
            "green": "#A8DF65",
            "light_green": "#5DD39E",
            "blue": "#7FD1B9",
            "light_blue": "#68E8A0",
        },
        "Palenight": {
            "base": "#292D3E",
            "mantle": "#444267",
            "crust": "#444267",

            "text": "#ECEFF4",

            "pink": "#FF5370",
            "purple": "#C792EA",
            "red": "#FF5370",
            "light_red": "#F07178",
            "orange": "#FFCB6B",
            "yellow": "#FFCB6B",
            "green": "#C3E88D",
            "light_green": "#AED581",
            "blue": "#82AAFF",
            "light_blue": "#80CBC4",
        },
        "Deep Ocean": {
            "base": "#0D2C54",
            "mantle": "#144668",
            "crust": "#1A5684",

            "text": "#CCE7E9",

            "pink": "#F77FBE",
            "purple": "#B041FF",
            "red": "#FF4E50",
            "light_red": "#FF6B6B",
            "orange": "#FFA07A",
            "yellow": "#FFD97D",
            "green": "#00CC99",
            "light_green": "#00E0B7",
            "blue": "#6D5DFC",
            "light_blue": "#1EAE98",
        },
        "Forest": {
            "base": "#0C351E",
            "mantle": "#1A512D",
            "crust": "#247035",

            "text": "#E6F1F2",

            "pink": "#FF80AB",
            "purple": "#8E44AD",
            "red": "#FF5252",
            "light_red": "#FF7F7F",
            "orange": "#FFB74D",
            "yellow": "#FFEE58",
            "green": "#2ECC71",
            "light_green": "#2BD6A6",
            "blue": "#3498DB",
            "light_blue": "#5BC0EB",
        },
        "Sky Blue": {
            "base": "#2C3E50",
            "mantle": "#3F5772",
            "crust": "#4D6E88",

            "text": "#EAECEE",

            "pink": "#FF6B6B",
            "purple": "#A37ACC",
            "red": "#FF7F50",
            "light_red": "#FF8C68",
            "orange": "#FFAB70",
            "yellow": "#FFD570",
            "green": "#1ABC9C",
            "light_green": "#20C9A6",
            "blue": "#3498DB",
            "light_blue": "#5BC0DE",
        },
        "Sandy Beach": {
            "base": "#FFF1E6",
            "mantle": "#FFD9B3",
            "crust": "#FFC196",

            "text": "#4A4A4A",

            "pink": "#FF7675",
            "purple": "#D6A2E8",
            "red": "#FDAC53",
            "light_red": "#FFC85B",
            "orange": "#F39C12",
            "yellow": "#FFD200",
            "green": "#91E763",
            "light_green": "#A2DE67",
            "blue": "#69C9D0",
            "light_blue": "#5ECCDD",
        },
        "Volcano": {
            "base": "#1C1116",
            "mantle": "#452B30",
            "crust": "#752F35",

            "text": "#ECEBE4",

            "pink": "#FF7582",
            "purple": "#D5A5D1",
            "red": "#FF3F34",
            "light_red": "#FF6F59",
            "orange": "#FF974F",
            "yellow": "#FFD166",
            "green": "#00818A",
            "light_green": "#00A69D",
            "blue": "#1B9AAA",
            "light_blue": "#6AB187",
        },
        "Space": {
            "base": "#2B2D42",
            "mantle": "#3C415C",
            "crust": "#495A75",

            "text": "#D9F0FF",

            "pink": "#FF6A88",
            "purple": "#D16DFF",
            "red": "#FF7171",
            "light_red": "#FF8E8E",
            "orange": "#FFAF7B",
            "yellow": "#FFD066",
            "green": "#76E3D6",
            "light_green": "#7EE8FA",
            "blue": "#3282B8",
            "light_blue": "#74B9FF",
        }
    }
}

let currentPalette = palettes["Catppuccin"]["Mocha"]

const userId = "330710628907876354"
const cardUser = {
    name: "Lucielle R. H.",
    username: "_vergessene",
    avatar: "./assets/imgs/icons/logo.svg",
    accent: "#000000",
    status: "offline",
    banner: {
        "url": null,
        "color": null
    }
}

function hexToRgb(hex) {
    const
        red = parseInt(hex.slice(1, 3), 16),
        green = parseInt(hex.slice(3, 5), 16),
        blue = parseInt(hex.slice(5, 7), 16);
    return {
        red: red,
        green: green,
        blue: blue,
        rgb: `${red}, ${green}, ${blue}`,
        hex: hex
    }
}

function updateCss() {
    for (let key in currentPalette) {
        document.documentElement.style.setProperty(`--${key}`, hexToRgb(currentPalette[key]).rgb);
    }
}

async function init() {
    initRendering()
    await updateCss()
    insertFileContentIn('content', 'home').then();
    document.documentElement.style.setProperty('--background-color', '#FFFFFF');
    await fetch(`https://discordlookup.mesavirep.xyz/v1/user/${userId}`)
        .then(response => response.json())
        .then(json => {
            cardUser.name = json.global_name;
            cardUser.username = json.username;
            cardUser.avatar = `${json.avatar.link}?size=4096`;
            cardUser.accent = json.accent_color;
            cardUser.banner = {
                "url": json.banner.link,
                "color": json.banner.color
            }
        })
        .catch(error => console.error(error))
        .then(_ => updateCards())
    fetch(`https://api.lanyard.rest/v1/users/${userId}`)
        .then(response => response.json())
        .then(json => {
            const data = json.data;
            cardUser.name = data.discord_user.display_name;
            cardUser.username = data.username;
            cardUser.avatar = `https://cdn.discordapp.com/avatars/${userId}/${data.discord_user.avatar}?size=4096`;
            cardUser.status = data.discord_status;
        })
        .catch(error => console.error(error))
        .then(_ => updateCards())
}

async function initGL(canvas, wglVersion) {
    const context = wglVersion === 2 ?
        (canvas.getContext("experimental-webgl2") || canvas.getContext("webgl2")) :
        (canvas.getContext("experimental-webgl") || canvas.getContext("webgl"));
    
    const positions = context.createBuffer();
    context.bindBuffer(context.ARRAY_BUFFER, positions);
    context.bufferData(context.ARRAY_BUFFER, new Float32Array([
        -1.0, 1.0, 0.0,
        -1.0, -1.0, 0.0,
        1.0, -1.0, 0.0,
        1.0, 1.0, 0.0
    ]), context.STATIC_DRAW);
    context.bindBuffer(context.ARRAY_BUFFER, null)

    const colors = context.createBuffer();
    context.bindBuffer(context.ARRAY_BUFFER, colors);
    context.bufferData(context.ARRAY_BUFFER, new Float32Array([1.0, 1.0, 1.0, 1.0]), context.STATIC_DRAW);
    context.bindBuffer(context.ARRAY_BUFFER, null)

    const elements_indices = [3, 2, 1, 3, 1, 0];
    const elements = context.createBuffer();
    context.bindBuffer(context.ELEMENT_ARRAY_BUFFER, elements);
    context.bufferData(context.ELEMENT_ARRAY_BUFFER, new Uint16Array(elements_indices), context.STATIC_DRAW);
    context.bindBuffer(context.ELEMENT_ARRAY_BUFFER, null);

    const es_key = wglVersion === 2 ? "es3" : "es1"

    const vertex_shader = context.createShader(context.VERTEX_SHADER);
    let vertex_shader_code = "";
    await fetch(`./assets/shaders/glsl/${es_key}/background/bg.vsh.glsl`)
        .then(response => response.text())
        .then(text => vertex_shader_code = text)
        .catch(error => console.error(error));
    context.shaderSource(vertex_shader, vertex_shader_code);
    context.compileShader(vertex_shader);
    let vertex_shader_log = context.getShaderInfoLog(vertex_shader);
    if (vertex_shader_log == null || vertex_shader_log.trim().length === 0) {
        console.info("vertex shader loaded.")
    } else console.warn(`vertex shader couldn't be loaded! (${vertex_shader_log})`);

    let fragment_shader_code = "";
    await fetch(`./assets/shaders/glsl/${es_key}/background/bg.fsh.glsl`)
        .then(response => response.text())
        .then(text => fragment_shader_code = text)
        .catch(error => console.error(error));

    const fragment_shader = context.createShader(context.FRAGMENT_SHADER);
    context.shaderSource(fragment_shader, fragment_shader_code);
    context.compileShader(fragment_shader);
    let fragment_shader_log = context.getShaderInfoLog(vertex_shader);
    if (fragment_shader_log == null || vertex_shader_log.trim().length === 0) {
        console.info("fragment shader loaded.")
    } else console.warn(`fragment shader couldn't be loaded! (${fragment_shader_log})`);

    const shaderProgram = context.createProgram();

    context.attachShader(shaderProgram, vertex_shader);
    context.attachShader(shaderProgram, fragment_shader);
    context.linkProgram(shaderProgram);
    context.useProgram(shaderProgram);

    const position = context.getAttribLocation(shaderProgram, "position");
    context.enableVertexAttribArray(position);
    context.bindBuffer(context.ARRAY_BUFFER, positions);
    context.vertexAttribPointer(position, 3, context.FLOAT, false, 0, 0);

    const color = context.getAttribLocation(shaderProgram, "color");
    context.enableVertexAttribArray(color);
    context.bindBuffer(context.ARRAY_BUFFER, colors);
    context.vertexAttribPointer(color, 4, context.FLOAT, false, 0, 0);

    context.bindBuffer(context.ELEMENT_ARRAY_BUFFER, elements);

    context.clearColor(0.0, 0.0, 0.0, 1.0);
    context.clear(context.COLOR_BUFFER_BIT);
    context.enable(context.DEPTH_TEST);

    const unimloc_matrix = context.getUniformLocation(shaderProgram, "model");
    const default_matrix = new Float32Array([1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0]);

    const unimloc_time = context.getUniformLocation(shaderProgram, "time");
    const unimloc_res = context.getUniformLocation(shaderProgram, "resolution");

    async function renderLoop(time) {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        context.uniformMatrix4fv(unimloc_matrix, false, default_matrix);

        context.uniform1f(unimloc_time, time / 1000.0);
        context.uniform2fv(unimloc_res, [canvas.width, canvas.height]);

        context.viewport(0, 0, canvas.width, canvas.height);
        context.drawElements(context.TRIANGLES, elements_indices.length, context.UNSIGNED_SHORT, 0);

        window.requestAnimationFrame(renderLoop);
    }

    window.requestAnimationFrame(renderLoop);
}

async function initWGPU(canvas) {
}

async function initRendering() {
    const canvas = document.querySelector("#shader-background");
    const version = // @formatter:off
        (//canvas.getContext("webgpu") != null ? 3 : TODO: ...
         canvas.getContext("experimental-webgl2") || canvas.getContext("webgl2")) != null ? 2 :
        (canvas.getContext("experimental-webgl" ) || canvas.getContext("webgl" )) != null ? 1 : 0;
    // @formatter:on
    switch (version) {
        case 1:
        case 2: {
            initGL(canvas, version)
            break;
        }

        case 3: {
            initWGPU(canvas)
            break;
        }

        default: {
            console.warn("couldn't find webgpu nor webgl, so no-no fancy shader-background. :(");
            break;
        }
    }
}

async function insertContentIn(destination, content) {
    document.getElementById(destination).innerHTML = content;
}

async function insertFileContentIn(destination, htmlFile) {
    fetch(`./router/${htmlFile}.html`)
        .then(response => response.text())
        .then(text => insertContentIn(destination, text))
        .catch(error => console.error(error));
}

function updateCards() {
    updateProfileCard()
    //updateActivities()
}

function updateProfileCard() {
    const svgNS = "http://www.w3.org/2000/svg";
    const cardWidth = 320;
    const cardHeight = 80;

    // Create SVG element
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("version", "1.1");
    svg.setAttribute("id", "profile-card");
    svg.setAttribute("xmlns", svgNS);
    svg.setAttribute("xmlns:xlink", svgNS);
    svg.setAttribute("width", cardWidth);
    svg.setAttribute("height", cardHeight);
    svg.setAttribute("viewBox", `0 0 ${cardWidth} ${cardHeight}`);
    svg.setAttribute("xml:space", "preserve");

    // defs
    // const defs = document.createElementNS(svgNS, "defs");
    // svg.appendChild(defs);

    // Background rectangle
    const background = document.createElementNS(svgNS, "rect");
    background.setAttribute("width", "100%");
    background.setAttribute("height", "100%");
    background.setAttribute("fill", cardUser.color);
    svg.appendChild(background);

    const bannerExists = cardUser.banner.url != null;
    if (bannerExists) {
        const banner = document.createElementNS(svgNS, "image");
        banner.setAttribute("x", cardHeight - 1.0);
        banner.setAttribute("y", 1.0);
        banner.setAttribute("x1", "100%");
        banner.setAttribute("y1", cardHeight - 1.0);
        banner.setAttribute("width", cardWidth - cardHeight);
        banner.setAttribute("href", cardUser.banner.url);
        svg.appendChild(banner);
    }

    // Profile Image
    const image = document.createElementNS(svgNS, "image");
    image.setAttribute("href", cardUser.avatar);
    image.setAttribute("x", 1.0);
    image.setAttribute("y", 1.0);
    image.setAttribute("width", cardHeight - 2.0);
    image.setAttribute("height", cardHeight - 2.0);
    svg.appendChild(image);

    // Name text
    const nameText = document.createElementNS(svgNS, "text");
    nameText.textContent = cardUser.name;
    nameText.setAttribute("x", cardHeight + 10.0);
    nameText.setAttribute("y", 20.0);
    nameText.setAttribute("font-size", "20");
    nameText.setAttribute("fill", "#FFFFFF");
    svg.appendChild(nameText);

    // Title text
    const titleText = document.createElementNS(svgNS, "text");
    titleText.textContent = cardUser.status;
    titleText.setAttribute("x", cardHeight + 10.0);
    titleText.setAttribute("y", 38.0);
    titleText.setAttribute("font-size", "14");
    let statusColor;
    switch (titleText.textContent) {
        case "online":
            statusColor = currentPalette.green;
            break;
        case "idle":
            statusColor = currentPalette.yellow;
            break;
        case "dnd":
            statusColor = currentPalette.red;
            break;
        default:
            statusColor = currentPalette.text;
            break;
    }
    titleText.setAttribute("fill", statusColor);
    svg.appendChild(titleText);

    const element = document.getElementById("profile-card")
    if (element.children.hasOwnProperty("profile-card")) element.replaceChildren(svg)
    else element.appendChild(svg);
}

function updateActivities() {
    const svgNS = "http://www.w3.org/2000/svg";
    const cardWidth = 320;
    const cardHeight = 80;

    // Create SVG element
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("version", "1.1");
    svg.setAttribute("id", "profile-card");
    svg.setAttribute("xmlns", svgNS);
    svg.setAttribute("xmlns:xlink", svgNS);
    svg.setAttribute("width", cardWidth);
    svg.setAttribute("height", cardHeight);
    svg.setAttribute("viewBox", `0 0 ${cardWidth} ${cardHeight}`);
    svg.setAttribute("xml:space", "preserve");

    const element = document.getElementById("activities-cards")
    if (element.children.hasOwnProperty("activities-cards")) element.replaceChildren(svg)
    else element.appendChild(svg);
}

init()
